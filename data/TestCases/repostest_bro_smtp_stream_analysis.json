{
    "functionName": "test_bro_smtp_stream_analysis",
    "className": "TestCase",
    "fileName": "/IntegralDefense_&_ACE/lib_&_saq_&_modules_&_test_email.py",
    "projectName": "repos",
    "Label": false,
    "isTest": true,
    "Body": "import saq\nimport saq.modules.email\nsaq.CONFIG['analysis_mode_email']['cleanup'] = 'no'\nroot = create_root_analysis(alert_type=ANALYSIS_TYPE_BRO_SMTP,\n    analysis_mode=ANALYSIS_MODE_EMAIL)\nroot.initialize_storage()\nroot.details = {}\nshutil.copy(os.path.join('test_data', 'smtp_streams', 'CBmtfvapmTMqCEUw6'),\n    os.path.join(root.storage_dir, 'CBmtfvapmTMqCEUw6'))\nfile_observable = root.add_observable(F_FILE, 'CBmtfvapmTMqCEUw6')\nfile_observable.add_directive(DIRECTIVE_ORIGINAL_SMTP)\nfile_observable.add_directive(DIRECTIVE_NO_SCAN)\nroot.save()\nroot.schedule()\nengine = TestEngine(local_analysis_modes=[ANALYSIS_MODE_EMAIL])\nengine.enable_module('analysis_module_file_type', 'test_groups')\nengine.enable_module('analysis_module_email_analyzer', 'test_groups')\nengine.enable_module('analysis_module_bro_smtp_analyzer', 'test_groups')\nengine.controlled_stop()\nengine.start()\nengine.wait()\nroot = RootAnalysis(storage_dir=root.storage_dir)\nroot.load()\nfile_observable = root.get_observable(file_observable.id)\nself.assertIsNotNone(file_observable)\nanalysis = file_observable.get_analysis(saq.modules.email.BroSMTPStreamAnalysis\n    )\nself.assertIsNotNone(analysis)\nself.assertEquals(len(analysis.get_observables_by_type(F_FILE)), 1)\nself.assertEquals(len(analysis.get_observables_by_type(F_EMAIL_ADDRESS)), 2)\nself.assertEquals(len(analysis.get_observables_by_type(F_IPV4)), 1)\nself.assertEquals(len(analysis.get_observables_by_type(F_EMAIL_CONVERSATION\n    )), 1)\nself.assertTrue(saq.modules.email.KEY_CONNECTION_ID in analysis.details)\nself.assertTrue(saq.modules.email.KEY_SOURCE_IPV4 in analysis.details)\nself.assertTrue(saq.modules.email.KEY_SOURCE_PORT in analysis.details)\nself.assertTrue(saq.modules.email.KEY_ENV_MAIL_FROM in analysis.details)\nself.assertTrue(saq.modules.email.KEY_ENV_RCPT_TO in analysis.details)\nemail_file = analysis.find_observable(lambda o: o.type == F_FILE)\nself.assertIsNotNone(email_file)\nself.assertEquals(email_file.value, 'email.rfc822')\nemail_analysis = email_file.get_analysis(saq.modules.email.EmailAnalysis)\nself.assertIsNotNone(email_analysis)\n"
}