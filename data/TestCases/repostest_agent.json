{
    "functionName": "test_agent",
    "className": null,
    "fileName": "/glentner_&_CmdKit/tests_&_test_service.py",
    "projectName": "repos",
    "Label": false,
    "isTest": true,
    "Body": "\"\"\"Test that the agent starts and runs its task three times.\"\"\"\ndatfile = f'{DemoAgent.pid_dir}/{DemoAgent.name}.dat'\nif os.path.exists(datfile):\n    os.remove(datfile)\nlog.debug(f'starting agent')\np = Process(target=DemoAgent.test, args=('start',))\np.start()\np.join()\npidfile = f'{DemoAgent.pid_dir}/{DemoAgent.name}.pid'\nwith open(pidfile, mode='r') as f:\n    PID = int(f.read().strip())\n    log.debug(f'agent had pid={PID}')\ncheck_call(['ps', str(PID)])\ntime.sleep(3)\nlog.debug(f'stopping agent')\np = Process(target=DemoAgent.test, args=('stop',))\np.start()\np.join()\nassert not os.path.exists(pidfile)\nwith pytest.raises(CalledProcessError):\n    check_call(['ps', str(PID)])\nassert os.path.exists(datfile)\nwith open(datfile, mode='r') as f:\n    lines = [line.strip() for line in f.readlines()]\nassert len(lines) >= 3\nassert all(line == 'task complete' for line in lines)\n"
}