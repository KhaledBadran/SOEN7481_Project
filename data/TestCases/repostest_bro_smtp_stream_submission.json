{
    "functionName": "test_bro_smtp_stream_submission",
    "className": "TestCase",
    "fileName": "/IntegralDefense_&_ACE/lib_&_saq_&_modules_&_test_email.py",
    "projectName": "repos",
    "Label": false,
    "isTest": true,
    "Body": "from flask import url_for\nfrom saq.analysis import _JSONEncoder\nfrom saq.modules.email import EmailAnalysis, BroSMTPStreamAnalysis\nt = saq.LOCAL_TIMEZONE.localize(datetime.datetime.now()).astimezone(pytz.UTC\n    ).strftime(event_time_format_json_tz)\nwith open(os.path.join('test_data', 'smtp_streams', 'CBmtfvapmTMqCEUw6'), 'rb'\n    ) as fp:\n    result = self.client.post(url_for('analysis.submit'), data={'analysis':\n        json.dumps({'analysis_mode': ANALYSIS_MODE_EMAIL, 'tool':\n        'unittest', 'tool_instance': 'unittest_instance', 'type':\n        ANALYSIS_TYPE_BRO_SMTP, 'description':\n        'BRO SMTP Scanner Detection - ', 'event_time': t, 'details': {},\n        'observables': [{'type': F_FILE, 'value': 'CBmtfvapmTMqCEUw6',\n        'time': t, 'tags': [], 'directives': [DIRECTIVE_ORIGINAL_SMTP],\n        'limited_analysis': []}], 'tags': []}, cls=_JSONEncoder), 'file': (\n        fp, 'CBmtfvapmTMqCEUw6')}, content_type='multipart/form-data')\nresult = result.get_json()\nself.assertIsNotNone(result)\nself.assertTrue('result' in result)\nresult = result['result']\nself.assertIsNotNone(result['uuid'])\nuuid = result['uuid']\nsaq.CONFIG['analysis_mode_email']['cleanup'] = 'no'\nengine = TestEngine(local_analysis_modes=[ANALYSIS_MODE_EMAIL])\nengine.enable_module('analysis_module_file_type', 'email')\nengine.enable_module('analysis_module_email_analyzer', 'email')\nengine.enable_module('analysis_module_bro_smtp_analyzer', 'email')\nengine.controlled_stop()\nengine.start()\nengine.wait()\nroot = RootAnalysis(storage_dir=workload_storage_dir(uuid))\nroot.load()\nobservable = root.find_observable(lambda o: o.has_directive(\n    DIRECTIVE_ORIGINAL_SMTP))\nself.assertIsNotNone(observable)\nanalysis = observable.get_analysis(BroSMTPStreamAnalysis)\nself.assertIsNotNone(analysis)\n"
}